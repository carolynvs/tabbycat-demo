name: tabbycat-demo
version: 0.1.0
description: "Demo bundle that deploys TabbyCat to Azure"
registry: "localhost:5000/carolynvs"

custom:
  appVersion: 0.1.0

mixins:
  - exec
  - helm3
  - terraform:
      clientVersion: 1.0.4
      initFile: providers.tf

credentials:
  - name: subscription
    description: Azure subscription id
    env: ARM_SUBSCRIPTION_ID
  - name: tenant
    description: Azure service principal tenant id
    env: ARM_TENANT_ID
  - name: client
    description: Azure service principal client id
    env: ARM_CLIENT_ID
  - name: client-secret
    description: Azure service principal client secret
    env: ARM_CLIENT_SECRET

parameters:
  - name: location
    description: Azure location for the db
    type: string
    default: centralus
    applyTo:
      - install
  - name: kubeconfig
    type: string
    path: /root/.kube/config
    source:
      output: kubeconfig
  - name: tfstate
    type: file
    path: /cnab/app/terraform/terraform.tfstate
    source:
      output: tfstate
  - name: tfvars
    type: file
    path: /cnab/app/terraform/terraform.tfvars.json
    source:
      output: tfvars

outputs:
  - name: tfstate
    type: file
    path: /cnab/app/terraform/terraform.tfstate
  - name: tfvars
    type: file
    path: /cnab/app/terraform/terraform.tfvars.json
  - name: static_ip
    type: string
    applyTo:
      - install
  - name: kubeconfig
    type: string
    applyTo:
      - install
  - name: cluster_certificate
    type: string
    applyTo:
      - install

install:
  - terraform:
      description: "Create infrastructure"
      vars:
        installation: "{{ installation.name}}"
        location: "{{ bundle.parameters.location }}"
      outputs:
        - name: static_ip
        - name: kubeconfig
        - name: cluster_certificate
  - exec:
      command: ./helpers.sh
      arguments:
        - save-kubeconfig
        - "{{ bundle.outputs.kubeconfig }}"
  - helm3:
      description: "Install myapp"
      name: "{{ installation.name }}"
      chart: ./chart
      version: "{{ bundle.custom.appVersion }}"
      upsert: true
      set:
        connStr: "{{ bundle.outputs.static_ip }}"

upgrade:
  - helm3:
      description: "Install myapp"
      name: "{{ installation.name }}"
      chart: ./chart
      version: "{{ bundle.custom.appVersion }}"
      upsert: true
      set:
        connStr: "{{ bundle.outputs.static_ip }}"

uninstall:
  - terraform:
      description: "Destroy infrastructure"
